pipeline {
      environment {
        NPM_REGISTRY = 'http://localhost:4873'
    }
    agent {
        kubernetes {
            yaml '''
apiVersion: v1
kind: Pod
spec:
  serviceAccountName: jenkins
  containers:
    - name: shell
      image: node:latest
      command: ["sleep"]
      args: ["infinity"]
      securityContext:
        privileged: true
      resources:
        requests:
          cpu: "6000m"
        limits:
          cpu: "7"
    - name: verdaccio
      image: verdaccio/verdaccio
      ports:
        - containerPort: 4873
      resources:
        requests:
          cpu: "1000m"
        limits:
          cpu: "1"
      volumeMounts:
        - name: verdaccio-config
          mountPath: "/verdaccio/conf/"
  volumes:
    - name: verdaccio-config
      configMap:
        name: verdaccio-config
'''
            defaultContainer 'shell'
            retries 2
            }
        }

    stages {
        stage('Geting Vendure source') {
            steps {
                checkout scmGit(
                    branches: [[name: 'main']],
                    userRemoteConfigs: [[url: 'https://github.com/LT-Linas35/vendure-showcase.git']])
            }
        }
        stage('Parallel tasks') {
              parallel {
                stage('Installing buildah') {
                  steps {
                    sh '''
                    apt update && apt install -y buildah
                    '''    
                  }
                }
                stage('Installing AWS CLI') {
                  steps {
                    sh '''
                    curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
                    unzip awscliv2.zip
                    ./aws/install                    
                    '''    
                  }
                }
                stage('Installing Lerna') {
                  steps {
                    sh '''
                    npm install lerna                 
                    '''    
                  }
                }
                stage('Installing Vendure Dependencies') {
                  steps {
                      dir('vendure-source') {
                        sh '''
                        npm install --production
                        '''
                        } 
                    }
                }
              }
            }        
        
        stage('Building Vendure packages') {
            steps {
              dir('vendure-source') {
                sh 'npm run build'
              }
            }
        }
/*
        stage('Running Vendure tests') {
            steps {
              dir('vendure-source') {
                sh 'npm run test'
            } 
          }
        }
*/
        stage('Configuring NPM Registry') {
            steps {
              sh """npm config set //localhost:4873/:_authToken=none"""
              sh """npm config set @vendure:registry ${env.NPM_REGISTRY}"""
            }
        }
        stage('Publish NPM Packages') {
            steps {
              dir('vendure-source') {
                script {
                    def packages = [
                        "packages/common",
                        "packages/core",
                        "packages/admin-ui-plugin",
                        "packages/asset-server-plugin",
                        "packages/email-plugin",
                        "packages/graphiql-plugin"
                    ]
                    packages.each { pkg ->
                        dir(pkg) {
                            echo "Publishing package in ${pkg}"
                            sh "npm publish --registry ${env.NPM_REGISTRY}"
                        }
                    }
                }
            }
          }
        } 
        stage('Login to ECR Hub') {
          steps {
            script {
              sh '''
                aws ecr get-login-password --region eu-west-2 | buildah login --username AWS --password-stdin 975050322104.dkr.ecr.eu-west-2.amazonaws.com
                '''
            }
          }
        }
        stage('Build & Push') {
            steps {
                dir('vendure-showcase') {
                    sh '''
                    npm install --production
                    npm run build
                    buildah bud -t 975050322104.dkr.ecr.eu-west-2.amazonaws.com/vendure-showcase:latest .
                    buildah push 975050322104.dkr.ecr.eu-west-2.amazonaws.com/vendure-showcase:latest
                    '''
                }
            }
        }
    }
}